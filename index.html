<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Goorm 과제 저장소 | 타임라인</title>
    <style>
      :root {
        --primary: #006241;
        --bg: #f8f9fa;
      }
      body {
        font-family:
          "Pretendard",
          -apple-system,
          sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 40px 20px;
      }
      .container {
        max-width: 750px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 50px;
      }
      header h1 {
        color: var(--primary);
        font-size: 2.5rem;
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }
      header p {
        color: #666;
      }

      /* 주차별 그룹 (아코디언) */
      details {
        background: white;
        margin-bottom: 15px;
        border-radius: 15px;
        border: 1px solid #eee;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      }
      summary {
        padding: 20px 24px;
        font-weight: 700;
        cursor: pointer;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s ease;
      }
      details[open] summary {
        border-bottom: 1px solid #eee;
        background: #f9fdfb;
        color: var(--primary);
      }
      summary::after {
        content: "＋";
        font-size: 1rem;
        color: #aaa;
      }
      details[open] summary::after {
        content: "－";
        color: var(--primary);
      }

      /* 과제 리스트 정렬 레이아웃 */
      .task-list {
        padding: 10px 15px 20px;
      }
      .task-card {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        text-decoration: none;
        color: #333;
        border-bottom: 1px solid #f5f5f5;
        transition: all 0.2s ease;
        border-radius: 8px;
      }
      .task-card:last-child {
        border-bottom: none;
      }
      .task-card:hover {
        background: #f8fdfb;
        color: var(--primary);
        transform: translateX(4px);
      }

      .task-info {
        display: flex;
        align-items: center;
        flex-grow: 1;
      }

      /* 1. 태그 섹션 (너비 고정) */
      .tag {
        width: 55px;
        text-align: center;
        font-size: 0.65rem;
        padding: 3px 0;
        border-radius: 4px;
        font-weight: 800;
        margin-right: 20px;
        flex-shrink: 0;
      }
      .tag.quiz {
        background: #fff5b1;
        color: #856404;
        border: 1px solid #ffeeba;
      }
      .tag.study {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }

      /* 2. 날짜 섹션 (너비 고정) */
      .task-date {
        width: 70px;
        font-family: "Courier New", monospace;
        color: #999;
        font-size: 0.95rem;
        margin-right: 15px;
        flex-shrink: 0;
      }

      /* 3. 제목 섹션 (자동 정렬 시작점) */
      .task-title {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .loader {
        text-align: center;
        padding: 50px;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>WEB ARCHIVE</h1>
      </header>

      <div id="loader" class="loader">데이터를 분석 중입니다...</div>
      <div id="task-container"></div>
    </div>

    <script>
      async function fetchWeeklyData() {
        const owner = "khy0819";
        const repo = "Goormexp";
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/main?recursive=1`;

        try {
          const res = await fetch(apiUrl);
          const data = await res.json();

          // '과제/' 폴더 내 index.html 필터링
          const indexFiles = data.tree.filter(
            (f) =>
              f.path.includes("과제/") &&
              f.path.endsWith("index.html") &&
              f.path !== "index.html",
          );

          const weeks = {};
          indexFiles.forEach((f) => {
            const pathParts = f.path.split("/");
            const weekFolder = pathParts.find((p) =>
              p.toLowerCase().includes("week"),
            );
            let weekLabel = weekFolder
              ? weekFolder.toUpperCase().replace(/_/g, " ")
              : "기타 분류";
            let folderName = pathParts[pathParts.length - 2];

            if (!weeks[weekLabel]) weeks[weekLabel] = [];
            weeks[weekLabel].push({ path: f.path, name: folderName });
          });

          const container = document.getElementById("task-container");
          document.getElementById("loader").style.display = "none";

          const sortedWeeks = Object.keys(weeks).sort((a, b) =>
            a.localeCompare(b, undefined, { numeric: true }),
          );

          sortedWeeks.forEach((week) => {
            const details = document.createElement("details");
            if (week === sortedWeeks[sortedWeeks.length - 1])
              details.open = true;

            let html = `<summary>${week} (${weeks[week].length} 건)</summary><div class="task-list">`;

            weeks[week]
              .sort((a, b) => a.name.localeCompare(b.name))
              .forEach((task) => {
                const parts = task.name.split("-");
                const datePart = parts[0] || "000000";

                // 태그 판별
                let isQuiz = task.name.toUpperCase().includes("QUIZ");
                let tagText = isQuiz ? "QUIZ" : "STUDY";
                let tagClass = isQuiz ? "quiz" : "study";

                // 중복 제거된 제목 추출 (날짜와 유형 키워드 제외)
                let titlePart = parts.slice(2).join("-");
                if (!titlePart) titlePart = parts[1] || "과제물";

                // QUIZ, STUDY, TASK 등의 키워드 제거
                titlePart = titlePart
                  .replace(/^(QUIZ|quiz|Quiz)[-_]?/i, "")
                  .replace(/^(STUDY|study|Study)[-_]?/i, "")
                  .replace(/^(TASK|task|Task)[-_]?/i, "")
                  .trim();

                html += `
                            <a href="${encodeURI(task.path)}" class="task-card">
                                <div class="task-info">
                                    <span class="tag ${tagClass}">${tagText}</span>
                                    <span class="task-date">${datePart}</span>
                                    <span class="task-title">${titlePart}</span>
                                </div>
                                <span style="color:#eee">›</span>
                            </a>`;
              });

            html += `</div>`;
            details.innerHTML = html;
            container.appendChild(details);
          });
        } catch (e) {
          document.getElementById("loader").innerText =
            "로드 실패. 경로를 확인해주세요.";
        }
      }
      fetchWeeklyData();
    </script>
  </body>
</html>
